{% extends 'base.html' %}
{% load static %}
{% load currency %}

{% block title %}Chi tiết đơn hàng #{{ order.id }} - Software Store{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Đơn hàng #{{ order.id }}
                </h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">
                    Đặt ngày {{ order.created_at|date:"d/m/Y H:i" }}
                </p>
            </div>
            <div>
                <span class="px-3 py-1 text-sm font-medium rounded-full {{ payment_status.class }}">
                    {{ payment_status.text }}
                </span>
            </div>
        </div>
    </div>

    <div class="border-t border-gray-200">
        <dl>
            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">Tổng tiền</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ order.total_amount|currency }}</dd>
            </div>
            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">Phương thức thanh toán</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">SePay</dd>
            </div>
        </dl>
    </div>

    <div class="px-4 py-5 sm:px-6">
        <h4 class="text-lg font-medium text-gray-900">Sản phẩm</h4>
        <div class="mt-4 space-y-4">
            {% for item in order.items.all %}
            <div class="border-t border-gray-200 pt-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="{{ item.product.thumbnail.url }}" alt="{{ item.product.name }}" class="w-16 h-16 object-cover rounded">
                        <div class="ml-4">
                            <h5 class="text-sm font-medium text-gray-900">{{ item.product.name }}</h5>
                            <p class="text-sm text-gray-500">{{ item.price|currency }}</p>
                            {% if item.license_key %}
                            <p class="mt-1">
                                <span class="text-xs font-medium text-gray-500">License key:</span>
                                <code class="ml-2 px-2 py-1 text-xs bg-gray-100 rounded">{{ item.license_key }}</code>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% if order.status == 'completed' and item.download_url %}
                    <a href="{{ item.download_url }}" class="ml-4 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Tải xuống
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="px-4 py-5 sm:px-6 border-t border-gray-200">
        <div class="flex justify-between items-center">
            <a href="{% url 'orders:list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Quay lại danh sách
            </a>
            {% if payment_status.show_payment_button %}
            <button id="payment-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                Tiếp tục thanh toán
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Thanh toán -->
<div id="payment-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
        <div class="flex justify-between items-start">
            <h3 class="text-lg font-medium text-gray-900">Thanh toán đơn hàng #{{ order.id }}</h3>
            <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="mt-4">
            <p class="text-sm text-gray-500 mb-4">Quét mã QR bên dưới để thanh toán đơn hàng của bạn:</p>
            <div class="flex flex-col items-center">
                <div class="bg-gray-100 p-4 rounded-lg">
                    {# Ưu tiên hiển thị QR code từ URL thanh toán #}
                    <img id="qr-code" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{ payment_url|default:'sepay://pay/'|add:order.id|stringformat:'d'|add:'?amount='|add:order.total_amount|stringformat:'d' }}" alt="QR Code" class="w-48 h-48">
                </div>
                <p class="mt-4 text-sm text-gray-700 text-center">Số tiền: <span class="font-bold">{{ order.total_amount|currency }}</span></p>
                <p class="text-sm text-gray-500 text-center">Đơn hàng #{{ order.id }}</p>
                
                <div class="mt-6 flex flex-col items-center">
                    <div id="countdown" class="text-sm text-gray-500 mb-2">Mã QR có hiệu lực trong: <span id="time-remaining">15:00</span></div>
                    <div id="payment-status" class="px-2 py-1 text-yellow-800 text-xs font-medium bg-yellow-100 rounded-full">
                        Đang chờ thanh toán
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-between">
                <button id="cancel-payment" class="px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Hủy
                </button>
                <a href="{{ payment_url }}" target="_blank" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    Mở trang thanh toán
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lấy các phần tử DOM
    var paymentBtn = document.getElementById('payment-btn');
    var paymentModal = document.getElementById('payment-modal');
    var closeModal = document.getElementById('close-modal');
    var cancelPayment = document.getElementById('cancel-payment');
    var timeRemaining = document.getElementById('time-remaining');
    var statusElement = document.getElementById('payment-status');
    var orderId = "{{ order.id }}";
    
    // In ra URL thanh toán để kiểm tra
    console.log("URL thanh toán: {{ payment_url }}");
    
    // Biến toàn cục
    var countdownInterval = null;
    var checkPaymentStatusInterval = null;
    var timeLeft = 15 * 60; // 15 phút
    
    // Xử lý sự kiện nút thanh toán
    if (paymentBtn) {
        paymentBtn.addEventListener('click', function() {
            paymentModal.classList.remove('hidden');
            startCountdown();
            checkPaymentStatusInterval = setInterval(function() {
                checkPaymentStatus();
            }, 5000);
        });
    }
    
    // Xử lý sự kiện đóng modal
    if (closeModal) {
        closeModal.addEventListener('click', function() {
            paymentModal.classList.add('hidden');
            if (countdownInterval) clearInterval(countdownInterval);
            if (checkPaymentStatusInterval) clearInterval(checkPaymentStatusInterval);
        });
    }
    
    // Xử lý sự kiện hủy thanh toán
    if (cancelPayment) {
        cancelPayment.addEventListener('click', function() {
            paymentModal.classList.add('hidden');
            if (countdownInterval) clearInterval(countdownInterval);
            if (checkPaymentStatusInterval) clearInterval(checkPaymentStatusInterval);
        });
    }
    
    // Hàm bắt đầu đếm ngược
    function startCountdown() {
        updateCountdown();
        countdownInterval = setInterval(function() {
            updateCountdown();
        }, 1000);
    }
    
    // Hàm cập nhật đếm ngược
    function updateCountdown() {
        if (timeLeft <= 0) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (checkPaymentStatusInterval) clearInterval(checkPaymentStatusInterval);
            timeRemaining.textContent = 'Hết hạn';
            statusElement.className = 'px-2 py-1 text-red-800 text-xs font-medium bg-red-100 rounded-full';
            statusElement.textContent = 'Mã QR hết hạn';
            return;
        }
        
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        var formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
        timeRemaining.textContent = minutes + ':' + formattedSeconds;
        timeLeft--;
    }
    
    // Hàm kiểm tra trạng thái thanh toán
    function checkPaymentStatus() {
        fetch('/orders/payment/check/' + orderId + '/')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'completed') {
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (checkPaymentStatusInterval) clearInterval(checkPaymentStatusInterval);
                    statusElement.className = 'px-2 py-1 text-green-800 text-xs font-medium bg-green-100 rounded-full';
                    statusElement.textContent = 'Thanh toán thành công';
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                } else if (data.status === 'cancelled') {
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (checkPaymentStatusInterval) clearInterval(checkPaymentStatusInterval);
                    statusElement.className = 'px-2 py-1 text-red-800 text-xs font-medium bg-red-100 rounded-full';
                    statusElement.textContent = 'Đơn hàng đã bị hủy';
                }
            })
            .catch(function(error) {
                console.error('Error checking payment status:', error);
            });
    }
});
</script>
{% endblock %} 